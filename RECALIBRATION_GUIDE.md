# 重新标定操作指南

## 🎯 **目标**
- 标定误差：< 10mm（优秀）
- 数据质量：中心距离误差 < 15mm
- 采集数量：20+ 个高质量位姿

---

## 📋 **准备工作清单**

### 硬件准备：
- [ ] 调整相机高度（或降低机械臂工作高度）
- [ ] 目标：标定板距离相机 **0.35-0.60m**
- [ ] 改善棋盘格表面（降低反光）：
  - 方案A：使用哑光打印纸重新打印
  - 方案B：在现有白色方块上覆盖薄的哑光膜/胶带
  - 方案C：使用亚克力板 + 哑光喷漆
- [ ] 准备柔和LED照明（避免强光直射）
- [ ] 确认标定板固定牢固（不晃动）

### 软件准备：
```bash
cd /home/zyj/lerobot
conda activate lerobot

# 1. 备份旧数据
mkdir -p outputs/backup
mv outputs/hand_eye_data.json outputs/backup/hand_eye_data_old_$(date +%Y%m%d_%H%M%S).json 2>/dev/null || true
mv outputs/hand_eye_pose_*.png outputs/backup/ 2>/dev/null || true

# 2. 清理中间文件
rm -f outputs/hand_eye_data_filtered.json
rm -f outputs/camera_to_base_calibration.json
rm -f outputs/camera_to_base_calibration_filtered.json

# 3. 验证环境
python -c "from lerobot.robots.so101_follower import SO101Follower; from lerobot.cameras.realsense import RealSenseCamera; print('✅ 环境OK')"
```

---

## 🚀 **重新采集流程**

### 步骤1：启动数据采集
```bash
cd /home/zyj/lerobot
conda activate lerobot
python hand_eye_calibration.py
```

### 步骤2：采集时的质量要求

**每个位姿都要检查以下指标：**

| 指标 | 要求 | 理想值 |
|------|------|-------|
| 有效深度点 | ≥ 15/20 | 18-20/20 |
| 中心距离误差 | < 50mm | < 15mm |
| 标定板距离（Z值） | > 0.30m | 0.35-0.60m |

**采集原则：宁缺毋滥！**
- ✅ 如果出现"中心距离误差 > 50mm"，放弃该位姿，重新调整
- ✅ 如果"PnP估计位置"Z < 0.30m，增加距离后重试
- ✅ 如果"有效深度点 < 15/20"，调整角度/光照后重试

### 步骤3：位姿分布要求

**确保覆盖整个工作空间：**
- 不同的 X, Y, Z 位置（至少各3个不同值）
- 不同的旋转角度（至少包含正面、侧面、倾斜）
- 均匀分散，不要集中在某个区域

**建议采集顺序：**
1. 先在工作空间中心采集 5-8 个位姿（不同角度）
2. 然后在边缘区域采集 5-8 个位姿
3. 最后在高/低位置采集 5-8 个位姿
4. 总计：20-24 个高质量位姿

---

## 📊 **实时质量监控**

### 采集时的终端输出示例：

```
✅ 优秀位姿（直接保留）:
采集位姿 #5
  ✅ 有效深度点: 20/20
  深度点云中心: [0.045, -0.020, 0.450]m  ← Z > 0.35m ✅
  PnP估计位置: [0.038, -0.018, 0.445]m
  中心距离误差: 8.5mm  ← < 15mm ✅
  ✅ 已保存: outputs/hand_eye_pose_05.png

⚠️ 一般位姿（可以保留，但不理想）:
采集位姿 #3
  ✅ 有效深度点: 18/20
  中心距离误差: 35.2mm  ← 可接受但不理想
  PnP估计位置 Z: 0.320m  ← 稍近

❌ 差位姿（应该放弃）:
采集位姿 #1
  ⚠️  有效深度点太少: 12/20  ← 太少
  中心距离误差: 125.8mm  ← 太大
  → 放弃，按Ctrl+C或按q退出该位姿，重新调整
```

---

## 🔄 **完整标定流程**

### 1. 数据采集（30-40分钟）
```bash
python hand_eye_calibration.py
# 采集 20+ 个高质量位姿
# 按 'q' 退出
```

**输出：** `outputs/hand_eye_data.json`

### 2. 数据过滤（可选，如果有差数据）
```bash
python filter_good_poses.py
```

**输出：** 
- `outputs/hand_eye_data_filtered.json`
- 显示保留/丢弃的位姿统计

**注意：** 
- 如果所有位姿质量都很好（中心误差 < 50mm），可以跳过过滤
- 如果有差数据（> 50mm），必须过滤

### 3. 求解标定

**方案A：使用过滤后的数据**
```bash
python hand_eye_solver_filtered.py
```

**方案B：直接使用所有数据（如果都是好数据）**
```bash
python hand_eye_solver.py
```

**输出：** 
- `outputs/camera_to_base_calibration.json` 或
- `outputs/camera_to_base_calibration_filtered.json`

### 4. 验证标定
```bash
python test_calibration.py
```

**期望输出：**
```
✅ 平均重投影误差: 5.2mm  ← 优秀！
✅ 最大误差: 12.5mm
✅ 标定质量: 优秀
```

---

## ✅ **成功标准**

### 数据采集阶段：
- ✅ 采集了 20+ 个位姿
- ✅ 90% 以上位姿的中心距离误差 < 20mm
- ✅ 所有位姿的标定板距离 > 0.30m（理想 > 0.35m）
- ✅ 位姿分布均匀覆盖工作空间

### 标定结果阶段：
- ✅ **优秀**：最终误差 < 10mm 🎉
- ⚠️ **良好**：最终误差 10-30mm（可用）
- ❌ **需重做**：最终误差 > 30mm

---

## 🔧 **常见问题处理**

### 问题1：中心距离误差总是 > 50mm
**原因：** 距离太近或反光严重
**解决：** 
1. 增加相机高度或降低机械臂
2. 改善棋盘格表面（降低反光）

### 问题2：有效深度点太少（< 15/20）
**原因：** 光照不好、角度太大、或反光
**解决：**
1. 调整照明（柔和LED灯）
2. 减小棋盘格倾斜角度（< 45°）
3. 避免强光直射

### 问题3：检测不到棋盘格
**原因：** 图像质量差、遮挡、或距离太远
**解决：**
1. 确保棋盘格完整可见
2. 调整光照
3. 检查棋盘格是否平整

### 问题4：标定后误差仍然 > 30mm
**原因：** 数据质量不够好
**解决：**
1. 检查保留的数据是否都是高质量（< 20mm误差）
2. 重新采集，更严格地控制距离和反光
3. 增加采集数量（25-30个位姿）

---

## 📝 **重新标定检查清单**

### 开始前：
- [ ] 已备份旧数据
- [ ] 已删除旧的标定结果
- [ ] 相机高度调整完成
- [ ] 棋盘格反光问题已改善
- [ ] 照明准备好

### 采集中：
- [ ] 每个位姿的中心距离误差 < 50mm（理想 < 15mm）
- [ ] 每个位姿的标定板距离 > 0.30m（理想 > 0.35m）
- [ ] 有效深度点 > 15/20（理想 18-20/20）
- [ ] 位姿分布均匀（不集中）

### 完成后：
- [ ] 采集了 20+ 个高质量位姿
- [ ] 过滤了差数据（如果有）
- [ ] 求解标定成功
- [ ] 最终误差 < 10mm（或至少 < 30mm）
- [ ] 验证标定通过

---

## 🎯 **下一步**

1. **现在开始准备**：调整相机高度、改善棋盘格反光
2. **清理旧数据**：运行上面的清理命令
3. **开始采集**：`python hand_eye_calibration.py`
4. **实时监控质量**：确保每个位姿都符合要求
5. **求解验证**：完成后运行标定求解和验证

---

## 📞 **需要帮助？**

如果遇到问题，查看：
- `cursor_docs/TROUBLESHOOTING.md` - 故障排查
- `cursor_docs/hand_eye_calibration_guide.md` - 完整指南
- `cursor_docs/ERROR_ANALYSIS.md` - 误差分析

祝标定成功！🎉
