# SO101均匀网格IK精度测试指南

## 📋 测试概述

### 测试目标
对SO101机械臂的逆运动学（IK）精度进行**全面、系统**的测试，覆盖整个工作空间，生成高精度的3D精度分布图。

### 测试规格
- **测试范围**：
  - X轴: 0.15m ~ 0.41m（间隔0.02m，14个点）
  - Y轴: -0.2m ~ 0.2m（间隔0.02m，21个点）
  - Z轴: 0.005m, 0.015m, 0.025m（3个高度）

- **总测试点数**: 14 × 21 × 3 = **882个点**

- **测试时间**: 预计约 **37分钟**（每点~2.5秒）

- **精度标准**: 误差 < 10mm 为达标

---

## 🚀 快速开始

### 1. 硬件准备
```bash
# 确保机械臂已连接并上电
# 端口通常为 /dev/ttyACM0

# 检查端口权限
ls -l /dev/ttyACM0

# 如果权限不足，运行：
sudo chmod 666 /dev/ttyACM0
```

### 2. 运行测试
```bash
# 激活环境
conda activate lerobot

# 运行测试（默认端口）
python test_ik_accuracy_uniform.py

# 或指定端口
python test_ik_accuracy_uniform.py /dev/ttyACM0
```

### 3. 生成可视化
```bash
# 测试完成后，自动提示可视化
# 或手动运行：
python visualize_uniform_results.py outputs/ik_accuracy_test_uniform/test_results_<时间戳>.csv

# 自动选择最新结果
python visualize_uniform_results.py
```

---

## 📊 测试过程

### 测试流程
1. **初始化**: 连接机械臂，初始化运动学求解器
2. **生成网格**: 自动生成882个均匀分布的目标点
3. **逐点测试**:
   - 读取当前关节角度
   - 计算目标位置的IK
   - 用FK验证IK精度（IK误差）
   - 发送命令到机械臂
   - 等待2.5秒移动
   - 读取实际到达位置（实际误差、电机误差）
4. **保存数据**: JSON、CSV、统计摘要

### 进度显示
测试过程中会实时显示：
```
测试进度: [123/882]
目标位置: X=0.250m, Y=0.040m, Z=0.015m
  IK计算误差: 5.23 mm
  实际位置误差: 8.76 mm
  电机执行误差: 3.53 mm
  ✅ 精度达标（<10mm）

📊 进度统计: 120/882 (13.6%)
   成功: 118/120 (98.3%)
   预计剩余时间: 31.5 分钟
```

### 记录数据
每个测试点记录以下数据：
- **目标坐标**: `target_x`, `target_y`, `target_z`
- **IK计算位置**: `ik_x`, `ik_y`, `ik_z`
- **实际到达位置**: `actual_x`, `actual_y`, `actual_z`
- **IK误差**: `ik_error_mm` = |IK位置 - 目标位置|
- **电机误差**: `motor_error_mm` = |实际位置 - IK位置|
- **实际误差**: `actual_error_mm` = |实际位置 - 目标位置|

---

## 📈 可视化结果

### 生成的图表

#### 1. **3D精度分布图** (`3d_precision_map.png`)
**4个视图展示精度达标情况：**
- **左上**: 3D全景图
- **右上**: XY平面俯视图
- **左下**: XZ平面侧视图
- **右下**: YZ平面正视图

**颜色编码：**
- 🟢 **绿色**: 误差 < 10mm（精度达标）
- 🔴 **红色**: 误差 ≥ 10mm（精度不达标）

**用途**: 一眼看出工作空间中哪些区域可以达到高精度

---

#### 2. **误差热力图** (`error_heatmap.png`)
**分Z层显示XY平面的误差分布：**
- 每个Z高度一个子图（3个子图）
- 每个点标注了精确的误差值（mm）
- 颜色从绿色（低误差）到红色（高误差）渐变
- 附带统计摘要子图

**用途**: 精确定位每个位置的误差大小

---

#### 3. **误差分布分析** (`error_distribution_analysis.png`)
**4个子图深入分析误差规律：**
- **误差直方图**: 查看误差的整体分布
- **X轴误差趋势**: 误差随X距离的变化
- **Y轴误差趋势**: 误差随Y位置的变化
- **Z轴误差对比**: 不同高度的误差对比

**用途**: 理解误差的系统性规律，找到影响因素

---

## 🎯 结果解读

### 关键指标

#### 精度达标率
```
达标点数 / 总点数 = X%
```
- **>90%**: 优秀 ✅
- **70-90%**: 良好 ⚠️
- **<70%**: 需要改进 ❌

#### 误差统计
- **平均误差**: 反映整体精度水平
- **最大误差**: 反映最坏情况
- **标准差**: 反映稳定性

### 预期结果（基于之前测试）

根据之前的随机测试（50点），预期结果：

**最佳区域（X=0.22-0.28m, Y=-0.03~0.03m）：**
- 精度达标率: ~80-90%
- 平均误差: ~10-15mm

**边缘区域（X<0.20m 或 X>0.30m，|Y|>0.05m）：**
- 精度达标率: ~30-50%
- 平均误差: ~25-40mm

**本次测试覆盖更广范围**，预期：
- 整体达标率: **50-70%**
- 中心区域达标率: **70-90%**
- 边缘区域达标率: **20-40%**

---

## 🔧 故障排除

### 常见问题

#### 1. 测试中断
```bash
# 如果测试意外中断，数据会自动保存已测试的部分
# 可以查看部分结果：
python visualize_uniform_results.py outputs/ik_accuracy_test_uniform/test_results_<时间戳>.csv
```

#### 2. 机械臂卡住不动
- 检查目标位置是否超出工作范围
- 检查`max_relative_target`设置（已设为`None`，允许大幅度移动）
- 手动断电重启机械臂

#### 3. IK求解失败
- 某些极端位置可能无法求解
- 测试会自动跳过并标记为失败
- 不影响后续测试

#### 4. 测试时间过长
```bash
# 如果只想测试部分区域，可以修改脚本中的范围：
# test_ik_accuracy_uniform.py 第95-97行

x_values = np.arange(0.20, 0.30 + 0.001, 0.02)  # 缩小X范围
y_values = np.arange(-0.05, 0.05 + 0.001, 0.02)  # 缩小Y范围
z_values = np.array([0.015])                      # 只测试一个高度
```

---

## 📂 输出文件

### 测试结果
```
outputs/ik_accuracy_test_uniform/
├── test_results_<时间戳>.json    # 原始数据（JSON格式）
├── test_results_<时间戳>.csv     # 表格数据（CSV格式）
└── test_summary_<时间戳>.txt     # 统计摘要（文本格式）
```

### 可视化图表
```
outputs/ik_accuracy_test_uniform/visualizations/
├── 3d_precision_map.png              # 3D精度分布图
├── error_heatmap.png                 # 误差热力图
└── error_distribution_analysis.png   # 误差分布分析
```

---

## 🎓 测试建议

### 测试前准备
1. **校准机械臂**: 确保`lerobot-calibrate`已正确完成
2. **清理工作空间**: 移除所有障碍物
3. **固定相机（如果有）**: 避免测试期间晃动
4. **充足时间**: 预留至少1小时（包括可视化和分析）

### 测试期间
1. **不要触碰机械臂**: 让它自动完成测试
2. **监控异常**: 注意是否有撞击、卡住等情况
3. **记录观察**: 如果发现某些区域特别不准，记录下来

### 测试后分析
1. **查看3D精度图**: 找出绿色区域（高精度区）
2. **分析误差热力图**: 了解误差的空间分布
3. **研究误差趋势**: 找出X/Y/Z哪个轴影响最大
4. **优化工作区**: 基于结果调整打地鼠的手机摆放位置

---

## 🔗 相关文件

- **测试脚本**: `test_ik_accuracy_uniform.py`
- **可视化脚本**: `visualize_uniform_results.py`
- **之前的测试**: `test_ik_accuracy.py`（随机采样版本）
- **IK测试指南**: `cursor_docs/IK_ACCURACY_TEST_GUIDE.md`
- **可视化分析**: `cursor_docs/IK_VISUALIZATION_ANALYSIS.md`

---

## 💡 打地鼠项目应用

### 如何使用测试结果

#### 1. 确定最佳手机摆放位置
```python
# 基于3D精度图，找出最大的绿色区域
# 假设最佳区域为：
BEST_REGION = {
    'x': (0.22, 0.28),  # 6cm范围
    'y': (-0.04, 0.04),  # 8cm范围
    'z': (0.01, 0.03),   # 2cm范围
}

# 手机中心应放在：
PHONE_CENTER = (0.25, 0.00, 0.02)
```

#### 2. 过滤不可达目标
```python
def is_high_precision_target(x, y, z):
    """判断目标是否在高精度区域"""
    return (0.22 <= x <= 0.28 and 
            -0.04 <= y <= 0.04 and
            0.01 <= z <= 0.03)

# 在游戏中只点击高精度区域的地鼠
if is_high_precision_target(target_x, target_y, target_z):
    robot.click(target_x, target_y, target_z)
else:
    print("目标在低精度区域，跳过")
```

#### 3. 误差补偿
```python
# 如果发现某个方向系统性偏差，可以添加补偿
X_OFFSET = -0.005  # 基于测试结果
Y_OFFSET = 0.002
Z_OFFSET = 0.000

corrected_target = (
    target_x + X_OFFSET,
    target_y + Y_OFFSET,
    target_z + Z_OFFSET
)
```

---

**测试时间**: 预计37分钟（882个点）  
**建议频率**: 每次重新校准机械臂后运行一次  
**关键指标**: 精度达标率 >60%，平均误差 <15mm
