# SO101 IK精度自动化测试指南

## 📋 测试目的

自动执行大量IK测试，评估：
1. **FK（正运动学）效果**：IK计算的准确性
2. **电机执行精度**：电机能否准确执行IK计算的结果
3. **工作空间分析**：找出精度最高的区域

---

## 🚀 快速开始

### 运行测试（默认100次）

```bash
conda activate lerobot
cd /home/zyj/lerobot
python test_ik_accuracy.py
```

### 指定测试次数

```bash
# 测试50次（快速测试）
python test_ik_accuracy.py 50

# 测试200次（详细测试）
python test_ik_accuracy.py 200
```

### 指定USB端口

```bash
python test_ik_accuracy.py 100 /dev/ttyACM0
```

---

## 📊 测试流程

1. **初始化**：连接机械臂、加载运动学
2. **生成测试点**：
   - 10个固定测试点（覆盖关键位置）
   - 90个随机测试点（在安全区域内）
3. **执行测试**：
   - 移动到目标位置
   - 记录：目标、IK计算、实际到达
4. **数据分析**：生成统计报告
5. **保存结果**：JSON、CSV、摘要文件

---

## 📈 输出结果

### 1. 实时输出

测试过程中会显示：

```
[1/100] 测试目标: (0.200, 0.000, 0.040) ✓ IK:8.5mm Act:11.2mm Mot:3.2mm
[2/100] 测试目标: (0.220, 0.030, 0.045) ✓ IK:12.3mm Act:15.8mm Mot:4.1mm
...
```

- **IK**：IK计算误差（目标 vs IK结果）
- **Act**：实际误差（目标 vs 实际到达）
- **Mot**：电机误差（IK结果 vs 实际到达）

### 2. 统计分析报告

测试完成后自动生成：

```
📊 基本统计：
  总测试次数: 100
  成功次数: 98
  失败次数: 2
  成功率: 98.0%

📐 IK误差统计（目标 vs IK计算）：
  平均误差: 15.32 mm
  中位数误差: 12.45 mm
  标准差: 8.67 mm
  最小误差: 3.21 mm
  最大误差: 45.78 mm
  < 10mm: 35 (35.7%)
  < 20mm: 68 (69.4%)
  < 30mm: 89 (90.8%)

🎯 实际误差统计（目标 vs 实际到达）：
  平均误差: 18.56 mm
  中位数误差: 15.23 mm
  ...

⚙️  电机执行误差统计（IK计算 vs 实际到达）：
  平均误差: 4.12 mm
  中位数误差: 3.45 mm
  ...

📍 工作空间区域分析：
  X轴（距离）分析：
    近距离 (0.18-0.21m): n=32, IK=10.2mm, 实际=12.5mm
    中距离 (0.21-0.24m): n=45, IK=15.6mm, 实际=18.9mm
    远距离 (0.24-0.27m): n=21, IK=25.3mm, 实际=28.7mm
  
  Y轴（左右）分析：
    右侧 (-0.05--0.02m): n=28, IK=18.2mm, 实际=21.3mm
    中心 (-0.02-0.02m): n=48, IK=12.1mm, 实际=14.8mm
    左侧 (0.02-0.05m): n=22, IK=19.5mm, 实际=23.1mm
  
  Z轴（高度）分析：
    低位 (0.02-0.04m): n=35, IK=11.5mm, 实际=13.9mm
    中位 (0.04-0.05m): n=42, IK=16.8mm, 实际=20.2mm
    高位 (0.05-0.06m): n=21, IK=22.3mm, 实际=26.5mm

🌟 最佳精度区域（实际误差 < 20mm的区域）：
  数量: 68 (69.4%)
  X范围: 0.180 - 0.250m
  Y范围: -0.040 - 0.040m
  Z范围: 0.020 - 0.055m
  平均误差: 12.34mm
```

### 3. 保存的文件

测试结果自动保存到 `outputs/ik_accuracy_test/`：

```
test_results_20260122_143025.json  # 原始数据（JSON格式）
test_results_20260122_143025.csv   # 表格数据（Excel可打开）
test_summary_20260122_143025.txt   # 统计摘要
```

---

## 📊 CSV表格说明

CSV文件包含以下列：

| 列名 | 说明 |
|------|------|
| `test_id` | 测试编号 |
| `target_x/y/z` | 目标位置（米）|
| `ik_x/y/z` | IK计算位置（米）|
| `actual_x/y/z` | 实际到达位置（米）|
| `ik_error_mm` | IK误差（毫米）|
| `actual_error_mm` | 实际误差（毫米）|
| `motor_error_mm` | 电机误差（毫米）|
| `move_time_s` | 移动耗时（秒）|
| `success` | 是否成功 |

可以用Excel/Python/R进一步分析。

---

## 🎯 如何解读结果

### 1. IK误差分析

**IK误差 = |IK计算位置 - 目标位置|**

- **< 10mm**：IK算法很准确 ✅
- **10-20mm**：IK算法较准确 ⚠️
- **> 20mm**：IK算法不够准确 ❌

**原因：**
- URDF模型与实际机械臂有偏差
- placo求解器在某些姿态下收敛不佳
- 起始位置影响IK收敛

### 2. 电机执行误差分析

**电机误差 = |实际位置 - IK计算位置|**

- **< 5mm**：电机执行很准确 ✅
- **5-10mm**：电机执行较准确 ⚠️
- **> 10mm**：电机执行不够准确 ❌

**原因：**
- 电机控制精度限制
- 机械间隙和磨损
- 负载影响
- 校准误差

### 3. 实际误差分析

**实际误差 = |实际位置 - 目标位置|**

这是**最终的综合误差**，包含IK和电机两部分：
```
实际误差 ≈ IK误差 + 电机误差
```

- **< 15mm**：打地鼠完全可行 ✅
- **15-25mm**：可以接受 ⚠️
- **> 25mm**：需要改进 ❌

---

## 💡 优化建议

### 如果IK误差大（> 20mm）

**问题在算法/模型：**
1. 等待手眼标定完成（会补偿URDF误差）
2. 或考虑重新测量URDF参数
3. 或调整placo的优化参数

### 如果电机误差大（> 5mm）

**问题在硬件：**
1. 检查机械臂是否有松动
2. 重新校准电机
3. 检查电机负载是否过大
4. 调整`max_relative_target`参数

### 如果某个区域误差特别大

**问题在工作空间：**
1. 避免在该区域放置手机
2. 或使用分步移动策略
3. 或设置休息位置靠近该区域

---

## ⏱️ 预计耗时

| 测试次数 | 预计时间 | 适用场景 |
|---------|---------|---------|
| 20次 | ~5分钟 | 快速验证 |
| 50次 | ~12分钟 | 一般测试 |
| 100次 | ~25分钟 | 详细测试（推荐）|
| 200次 | ~50分钟 | 完整评估 |

每次测试约15秒（移动3秒 + 等待2秒 + 记录1秒）

---

## 🔧 高级用法

### 修改测试区域

编辑 `test_ik_accuracy.py` 中的 `generate_test_positions` 方法：

```python
# 定义安全工作空间
x_range = (0.18, 0.27)  # ← 修改这里
y_range = (-0.05, 0.05)
z_range = (0.02, 0.06)
```

### 调整等待时间

如果机械臂移动较慢，增加等待时间：

```python
time.sleep(2.5)  # ← 修改这个值（秒）
```

### 中断测试

测试过程中按 `Ctrl+C` 可以中断，程序会：
1. 保存已完成的测试结果
2. 生成统计报告
3. 安全断开连接

---

## 📌 注意事项

### 测试前检查

- [ ] 机械臂已固定
- [ ] 运动范围内无障碍物
- [ ] USB已连接
- [ ] 已完成校准

### 测试中

- 程序会自动运行，无需人工干预
- 可以观察误差变化趋势
- 每10次测试会自动返回休息位置

### 测试后

- 查看统计报告，找出最佳区域
- 用Excel打开CSV文件，制作图表
- 根据结果调整打地鼠的手机摆放位置

---

## 🎯 对打地鼠项目的指导

测试完成后，根据结果：

1. **确定手机位置**：放在最佳精度区域的中心
2. **设置安全区域**：只允许在低误差区域点击
3. **设置误差阈值**：
   - IK误差 > 20mm → 拒绝点击
   - 实际误差 > 25mm → 认为点击失败
4. **优化移动策略**：
   - 如果起始位置影响大 → 使用休息位置策略
   - 如果电机误差大 → 增加移动后等待时间

---

**准备好了吗？运行测试吧！** 🚀

```bash
conda activate lerobot
python test_ik_accuracy.py
```
