# SO101 逆运动学（IK）测试指南

## 📋 测试目的

在等待标定板和触控笔改造期间，验证官方 `placo` 库的IK功能是否正常工作，为后续打地鼠项目做准备。

---

## 🎯 测试内容

1. ✅ **正运动学（FK）验证**：读取关节角度 → 计算末端位置
2. ✅ **逆运动学（IK）计算**：给定目标位置 → 计算关节角度
3. ✅ **实际移动验证**：发送关节角度 → 机械臂移动 → 验证位置精度
4. ✅ **姿态约束测试**：测试"只约束位置，姿态自由"模式

---

## 🚀 快速开始

### 1. 准备工作

```bash
# 激活conda环境
conda activate lerobot

# 确保机械臂已连接
# 检查USB端口：通常是 /dev/ttyUSB0 或 /dev/ttyACM0
```

### 2. 运行测试程序

```bash
cd /home/zyj/lerobot

# 默认使用 /dev/ttyUSB0 端口
python test_ik_movement.py

# 如果需要指定其他端口（例如 /dev/ttyACM0）
python test_ik_movement.py /dev/ttyACM0
```

**如何查找正确的端口：**
```bash
# 查看所有USB设备
ls -l /dev/ttyUSB* /dev/ttyACM*

# 常见端口：
# - /dev/ttyUSB0  (USB转串口适配器)
# - /dev/ttyACM0  (Arduino/MCU直连)
```

---

## 📝 使用说明

### 程序界面

程序启动后会显示交互式菜单：

```
============================================================
交互式IK测试模式
============================================================

当前末端位置: X=0.300m, Y=0.000m, Z=0.100m

------------------------------------------------------------
请选择操作：
  1. 查看当前位置
  2. 移动到指定位置（输入XYZ坐标）
  3. 预设测试位置
  4. 退出
------------------------------------------------------------
```

### 选项说明

#### **选项1：查看当前位置**
- 显示机械臂末端执行器当前的XYZ坐标（基座坐标系）
- 不移动机械臂，只读取状态

#### **选项2：移动到指定位置**
- 手动输入目标XYZ坐标
- 程序会自动计算IK并移动机械臂

**示例：**
```
请输入选项 (1-4): 2
  输入目标X坐标 (米): 0.25
  输入目标Y坐标 (米): 0.05
  输入目标Z坐标 (米): 0.08
```

#### **选项3：预设测试位置**
- 快速测试常用位置
- 预设位置：
  1. 正前方，低位：`(0.25, 0.00, 0.05)` - 模拟点击手机下方
  2. 正前方，中位：`(0.30, 0.00, 0.10)` - 模拟点击手机中心
  3. 左前方：`(0.25, 0.10, 0.08)` - 模拟点击手机左侧
  4. 右前方：`(0.25, -0.10, 0.08)` - 模拟点击手机右侧

#### **选项4：退出**
- 安全断开机械臂连接并退出程序

---

## 🔍 测试流程详解

当你选择移动到某个位置时，程序会执行以下步骤：

### 步骤1：读取当前状态
```
[步骤1] 读取当前机械臂状态...
  当前关节角度: [  0.  30. -45.  20.   0.]
  当前末端位置: X=0.300m, Y=0.000m, Z=0.100m
```

### 步骤2：构造目标位姿
```
[步骤2] 构造目标位姿（姿态权重=0.0）...
```
- **重要**：姿态权重设为0，表示只约束位置，姿态自由
- 这对打地鼠项目很重要（只需要到达XYZ位置，末端朝向可以自动调整）

### 步骤3：计算IK
```
[步骤3] 计算逆运动学（IK）...
✅ IK计算成功！
  目标关节角度: [  0.  25. -40.  18.   0.]
  关节角度变化: [  0.  -5.   5.  -2.   0.]
```

### 步骤4：验证IK结果
```
[步骤4] 验证IK结果（正运动学检查）...
  IK后FK位置: X=0.250m, Y=0.050m, Z=0.080m
  IK计算误差: 0.15 mm
```
- 程序会用FK反向验证IK计算是否正确
- 如果误差 > 10mm，会警告

### 步骤5：移动机械臂
```
[步骤5] 发送关节角度命令，移动机械臂...
⚠️  请确保机械臂周围无障碍物！
按 Enter 开始移动，输入 'n' 取消:
```
- **安全提示**：移动前会要求确认
- 按 Enter 确认移动，输入 'n' 取消

### 步骤6：验证到达精度
```
[步骤6] 验证机械臂是否到达目标位置...
  实际到达位置: X=0.250m, Y=0.050m, Z=0.080m
  实际位置误差: 0.82 mm
✅ 成功到达目标位置！
```

---

## ⚠️ 安全注意事项

### 🔴 移动前检查清单：

1. ✅ **确保机械臂已固定在桌面**（不会倾倒）
2. ✅ **清空机械臂运动范围内的所有物品**
3. ✅ **保持手动急停开关触手可及**（如果有）
4. ✅ **第一次测试时，先用小幅度移动**
5. ✅ **观察机械臂运动是否平滑**（如果抖动/异响，立即停止）

### 🟡 坐标系统理解：

```
机械臂基座坐标系（右手坐标系）：
  X轴：向前（红色）
  Y轴：向左（绿色）
  Z轴：向上（蓝色）

原点：机械臂基座底部中心
```

### 🟢 合理的目标坐标范围：

```
X: 0.15 ~ 0.40m  (太近会撞到机械臂本身，太远够不着)
Y: -0.15 ~ 0.15m (左右范围)
Z: 0.00 ~ 0.30m  (桌面高度到机械臂上方)
```

---

## 🐛 常见问题

### Q1: 程序报错 "placo is required"
**A:** 需要安装 placo 库：
```bash
pip install placo
```

### Q2: 机械臂连接失败
**A:** 检查USB连接和端口权限：
```bash
# 查看连接的设备
ls -l /dev/ttyUSB* /dev/ttyACM*

# 添加权限（如果需要）
sudo chmod 666 /dev/ttyUSB0
```

### Q3: IK计算失败
**A:** 可能原因：
1. 目标位置超出机械臂工作空间
2. 目标位置在奇异点附近
3. 关节限位约束冲突

**解决方法：**
- 尝试离机械臂更近/更远的位置
- 增大姿态自由度（已默认设置）
- 检查关节限位设置

### Q4: 机械臂移动不平滑/抖动
**A:** 可能原因：
1. 关节角度变化过大（一次移动超过30度）
2. 电机负载过大
3. 通信速率问题

**解决方法：**
- 分步移动（先移到中间位置，再到目标）
- 检查机械臂是否有异物卡住
- 降低移动速度（修改 `max_relative_target` 参数）

### Q5: 到达位置误差较大（>5mm）
**A:** 可能原因：
1. 机械臂校准不准确
2. 电机精度限制
3. URDF模型与实际机械臂有偏差

**解决方法：**
- 重新运行 `lerobot-calibrate` 校准
- 等待专业标定板到货后进行手眼标定
- 检查URDF中的连杆长度是否正确

---

## 📊 测试记录模板

建议记录每次测试的结果，以便后续分析：

```
测试时间：2026-01-21 14:30
测试目标：验证IK基本功能

测试1：正前方低位
  目标坐标：(0.25, 0.00, 0.05)
  IK误差：0.15 mm
  实际误差：0.82 mm
  结果：✅ 成功

测试2：左前方
  目标坐标：(0.25, 0.10, 0.08)
  IK误差：0.23 mm
  实际误差：1.52 mm
  结果：✅ 成功

测试3：右前方
  目标坐标：(0.25, -0.10, 0.08)
  IK误差：0.18 mm
  实际误差：1.21 mm
  结果：✅ 成功

总结：
- IK计算稳定，误差 < 0.5mm
- 实际到达误差 < 2mm，可接受
- 准备进行下一步：集成打地鼠检测
```

---

## 🎯 下一步计划

完成IK测试后，你可以：

1. ✅ **等待专业标定板到货** → 进行精确的手眼标定
2. ✅ **等待触控笔改造完成** → 修改URDF为4自由度
3. ✅ **开发简单的目标检测** → 用固定坐标模拟"地鼠"
4. ✅ **编写主控制循环** → 检测→IK→移动→点击

---

## 📞 遇到问题？

如果测试过程中遇到问题，记录以下信息：
- 错误信息的完整输出
- 当前机械臂位置
- 目标坐标
- 终端显示的所有步骤信息

然后咨询助手或查看官方文档。

---

**祝测试顺利！** 🚀
